name: ðŸ›¡ï¸ Validate Memory Integrity

on:
  pull_request:
    paths:
      - 'memory-exports/**'
      - 'playbooks/**'
      - 'templates/**'
      - '.github/workflows/validate-pr.yml'

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate PR

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ðŸ” Check for secrets
        id: secrets
        run: |
          echo "Checking for potential secrets..."

          # Patterns that indicate secrets
          PATTERNS=(
            "password"
            "secret"
            "token"
            "api[_-]key"
            "private[_-]key"
            "aws_secret"
            "DATABASE_URL"
            "PRIVATE_KEY"
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -ri "$pattern" --include="*.md" . 2>/dev/null; then
              echo "âš ï¸ Found potential secret pattern: $pattern"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "âŒ Potential secrets detected!"
            exit 1
          fi
          echo "âœ… No secrets detected"

      - name: ðŸ“¦ Check file sizes
        id: sizes
        run: |
          echo "Checking file sizes..."
          MAX_SIZE=52428800  # 50MB

          OVERSIZED=0
          while IFS= read -r file; do
            SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            if [ "$SIZE" -gt "$MAX_SIZE" ]; then
              echo "âŒ File too large (>${MAX_SIZE}): $file ($SIZE bytes)"
              OVERSIZED=1
            fi
          done < <(find . -type f)

          if [ $OVERSIZED -eq 1 ]; then
            exit 1
          fi
          echo "âœ… All files under size limit"

      - name: ðŸ“ Validate Markdown
        id: markdown
        run: |
          echo "Validating markdown files..."

          INVALID=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # Check if file is empty
              if [ ! -s "$file" ]; then
                echo "âš ï¸ Empty file: $file"
                INVALID=1
              fi

              # Check for common markdown issues
              if grep -q "TODO\|FIXME\|XXX" "$file"; then
                echo "âš ï¸ Unfinished content in: $file"
              fi
            fi
          done < <(find . -name "*.md" -type f)

          if [ $INVALID -eq 1 ]; then
            exit 1
          fi
          echo "âœ… Markdown validation passed"

      - name: âœ¨ Summary
        if: success()
        run: |
          echo "âœ… All security checks passed!"
          echo ""
          echo "ðŸ“Š Summary:"
          echo "  - No secrets detected"
          echo "  - File sizes OK"
          echo "  - Markdown valid"
          echo ""
          echo "ðŸŽ‰ Ready for review!"
